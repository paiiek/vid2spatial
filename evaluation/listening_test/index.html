<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vid2Spatial 공간 오디오 청취 평가</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', -apple-system, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; line-height: 1.6; }
  .container { max-width: 960px; margin: 0 auto; padding: 20px; }

  .page { display: none; }
  .page.active { display: block; }

  h1 { font-size: 1.8em; margin-bottom: 16px; color: #e94560; }
  h2 { color: #e94560; font-size: 1.3em; margin-bottom: 12px; }
  h3 { color: #e94560; font-size: 1.1em; margin: 16px 0 8px; }

  .info-box { background: #16213e; border-radius: 8px; padding: 16px 20px; margin: 16px 0; border-left: 4px solid #e94560; line-height: 1.8; }
  .info-box li { margin: 4px 0; }
  .info-box ol { padding-left: 20px; }
  .info-box ul { padding-left: 20px; }

  .warning-box { background: #2e1a1a; border-radius: 8px; padding: 14px 18px; margin: 14px 0; border-left: 4px solid #f59e0b; color: #fbbf24; }

  input[type="text"], input[type="number"], select {
    background: #16213e; border: 1px solid #444; color: #eee;
    padding: 10px 16px; border-radius: 6px; font-size: 1em; width: 100%; max-width: 360px;
  }
  select { cursor: pointer; }
  label { display: block; margin-bottom: 4px; font-weight: 600; color: #ccc; }
  .form-group { margin: 14px 0; }
  .form-row { display: flex; gap: 16px; flex-wrap: wrap; }
  .form-row .form-group { flex: 1; min-width: 160px; }

  .btn { display: inline-block; padding: 12px 28px; border-radius: 8px; border: none; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: #e94560; color: #fff; }
  .btn-primary:hover { background: #c73e54; transform: translateY(-1px); }
  .btn-secondary { background: #16213e; color: #e94560; border: 2px solid #e94560; }
  .btn-secondary:hover { background: #e94560; color: #fff; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-sm { padding: 8px 18px; font-size: 0.9em; }

  /* Progress */
  .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #333; }
  .progress-text { color: #888; font-size: 0.9em; }
  .progress-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 16px; }
  .progress-fill { height: 100%; background: #e94560; border-radius: 2px; transition: width 0.3s; }

  /* Video */
  .video-box { text-align: center; margin: 12px 0; }
  .video-box video { width: 100%; max-width: 640px; border-radius: 8px; background: #000; }

  /* Version toggle */
  .version-toggle { display: flex; justify-content: center; gap: 16px; margin: 16px 0; flex-wrap: wrap; }
  .ver-btn { padding: 10px 28px; border-radius: 24px; border: 2px solid #444; background: #16213e; color: #ccc; cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s; }
  .ver-btn.active { border-color: #e94560; color: #e94560; background: #2a1a2e; }
  .ver-btn:hover { border-color: #e94560; }
  .mono-btn { padding: 8px 16px; border-radius: 16px; border: 1px solid #555; background: #111; color: #888; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
  .mono-btn.active { border-color: #888; color: #ccc; }

  /* Play button */
  .play-row { text-align: center; margin: 10px 0; }

  /* Rating grid: 4 questions x 5-point scale */
  .rating-grid { margin: 20px 0; }
  .question-block { background: #16213e; border-radius: 8px; padding: 14px 18px; margin: 10px 0; }
  .q-header { margin-bottom: 4px; }
  .q-title { font-weight: 600; font-size: 1em; color: #e94560; }
  .q-instruction { color: #aaa; font-size: 0.85em; margin-bottom: 10px; }
  .scale-row { display: flex; justify-content: center; gap: 10px; margin: 8px 0; }
  .scale-btn { width: 52px; height: 52px; border-radius: 50%; border: 2px solid #444; background: #1a1a2e; color: #ccc; font-size: 1.3em; font-weight: 700; cursor: pointer; transition: all 0.15s; }
  .scale-btn:hover { border-color: #e94560; color: #e94560; }
  .scale-btn.selected { background: #e94560; color: #fff; border-color: #e94560; }
  .anchor-row { display: flex; justify-content: space-between; max-width: 320px; margin: 4px auto 0; font-size: 0.72em; color: #666; }
  .scale-labels { display: flex; justify-content: center; gap: 10px; margin-bottom: 2px; }
  .scale-labels span { width: 52px; text-align: center; font-size: 0.65em; color: #666; }

  /* Nav */
  .nav-row { display: flex; justify-content: space-between; margin-top: 20px; }

  /* Results */
  .thank-you { font-size: 1.3em; color: #4ade80; margin: 16px 0; }
  .result-table { width: 100%; border-collapse: collapse; margin: 14px 0; font-size: 0.9em; }
  .result-table th, .result-table td { padding: 6px 10px; border: 1px solid #333; text-align: center; }
  .result-table th { background: #16213e; color: #e94560; }

  /* Headphone check */
  .headphone-check { text-align: center; padding: 20px 0; }
  .headphone-check .btn { margin: 8px; }
  .check-result { margin-top: 12px; font-size: 0.9em; }
  .check-pass { color: #4ade80; }
  .check-fail { color: #f87171; }

  /* Privacy notice */
  .privacy { background: #1e1e30; border: 1px solid #333; border-radius: 8px; padding: 14px 18px; margin: 14px 0; font-size: 0.85em; color: #999; }

  /* Consent */
  .consent-row { margin: 16px 0; display: flex; align-items: flex-start; gap: 8px; }
  .consent-row input[type="checkbox"] { margin-top: 4px; width: 18px; height: 18px; cursor: pointer; }

  /* Responsive */
  @media (max-width: 600px) {
    .form-row { flex-direction: column; }
    .scale-btn { width: 44px; height: 44px; font-size: 1.1em; }
    .scale-labels span { width: 44px; }
  }
</style>
</head>
<body>

<div class="container">

<!-- ==================== Page 1: 안내 및 동의 ==================== -->
<div id="page-intro" class="page active">
  <h1>Vid2Spatial 공간 오디오 청취 평가</h1>

  <div class="info-box">
    <p>본 평가는 <strong>서울대학교 융합과학기술대학원 음악 오디오 연구실 (Music and Audio Research Group)</strong>의 멀티모달 공간 오디오 생성 (Multimodal Spatial Audio Generation) 연구의 일환으로, 비디오 기반 공간 오디오 렌더링의 주관적 품질을 평가하기 위해 진행됩니다.</p>
    <p style="margin-top:8px; color:#aaa; font-size:0.9em;">본 청취 평가는 비전 기반 파이프라인이 생성한 <strong>공간 제어 궤적 (spatial control trajectory)</strong>의 지각적 품질을 평가합니다. 모든 공간 조건은 <strong>헤드폰 청취를 위해 바이노럴 렌더링</strong>되어 제시됩니다.</p>
  </div>

  <div class="info-box">
    <strong>실험 개요</strong>
    <ul>
      <li>총 <strong>12개의 비디오 클립</strong>을 시청하며, 각 클립에 대해 <strong>3가지 오디오 버전</strong>을 비교 청취합니다.</li>
      <li>"버전 1"과 "버전 2"는 블라인드 배정되며, "모노 (참조용)"는 비교 기준으로 제공됩니다.</li>
      <li>각 버전에 대해 <strong>4개 차원</strong>을 <strong>5점 척도 (1~5)</strong>로 평가합니다.</li>
      <li>소요 시간: 약 <strong>20~30분</strong></li>
    </ul>
  </div>

  <div class="info-box">
    <strong>평가 차원</strong>
    <ol>
      <li><strong>공간 일치도</strong> &mdash; 소리의 위치가 영상 속 물체의 위치와 얼마나 일치하는가?</li>
      <li><strong>움직임 부드러움</strong> &mdash; 공간 오디오의 움직임이 부드럽고 자연스러운가?</li>
      <li><strong>거리감</strong> &mdash; 가까이/멀리의 거리 변화가 설득력 있는가?</li>
      <li><strong>종합 품질</strong> &mdash; 전반적인 공간 오디오 품질은 어떠한가?</li>
    </ol>
  </div>

  <div class="warning-box">
    <strong>청취 환경 안내</strong>
    <ol>
      <li>가능한 <strong>최대한 조용한 환경</strong>에서 실험에 응해 주십시오.</li>
      <li>볼륨을 <strong>편안한 수준</strong>으로 맞춰 주십시오.</li>
      <li><strong>차폐형 헤드폰 (권장)</strong> 또는 이어폰을 사용하여 주십시오.</li>
      <li>가능한 음원을 <strong>자세히, 끝까지</strong> 청취하신 후 답변하시길 부탁드립니다.</li>
      <li>반복 청취는 <strong>제한이 없으므로</strong> 자유로이 수행하시길 바랍니다.</li>
    </ol>
  </div>

  <div class="info-box">
    <strong>평가 진행 방법</strong>
    <ol>
      <li>비디오와 함께 "버전 1", "버전 2", "모노 (참조용)" 오디오를 전환하며 청취합니다.</li>
      <li>"버전 1"과 "버전 2"에 대해 각각 4개 차원을 1~5점으로 평가합니다.</li>
      <li>모노는 비교 기준으로만 제공되며 평가 대상이 아닙니다.</li>
      <li>모든 차원을 평가해야 다음 클립으로 이동할 수 있습니다.</li>
      <li>이전 클립으로 돌아가 수정하는 것도 가능합니다.</li>
    </ol>
  </div>

  <div class="privacy">
    <strong>개인정보 수집 안내</strong><br>
    수집되는 개인정보 (성명, 연락처)는 <strong>리워드 증정 목적 외에는 사용되지 않으며</strong>, 증정 완료 시 즉시 폐기됩니다. 평가 응답 데이터는 익명화되어 연구 목적으로만 활용됩니다.
  </div>

  <div class="consent-row">
    <input type="checkbox" id="consent-check">
    <label for="consent-check" style="display:inline; font-weight:normal; color: #ccc;">
      위 안내 사항을 충분히 읽었으며, 개인정보 수집 및 연구 활용에 동의합니다.
    </label>
  </div>

  <p style="margin-top: 14px; color: #888; font-size: 0.85em;">
    실험 주최자 연락처: <strong>백승렬</strong> &mdash; 010-9265-8369
  </p>

  <p style="margin-top: 20px;">
    <button class="btn btn-primary" onclick="goToDemographic()">다음: 기초 설문</button>
  </p>
</div>

<!-- ==================== Page 2: 기초 설문 ==================== -->
<div id="page-demographic" class="page">
  <h1>기초 설문</h1>
  <p style="color:#aaa; margin-bottom:16px;">리워드 증정 및 참가자 특성 파악을 위한 기본 정보를 입력해 주세요.</p>

  <div class="info-box">
    <h3 style="margin-top:0;">개인 정보 (리워드용)</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="d-name">성명</label>
        <input type="text" id="d-name" placeholder="예: 백승렬">
      </div>
      <div class="form-group">
        <label for="d-contact">연락처</label>
        <input type="text" id="d-contact" placeholder="예: 010-9265-8369">
      </div>
    </div>

    <h3>인적 사항</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="d-gender">성별</label>
        <select id="d-gender">
          <option value="">선택</option>
          <option value="male">남성</option>
          <option value="female">여성</option>
          <option value="other">기타 / 응답 거부</option>
        </select>
      </div>
      <div class="form-group">
        <label for="d-age">나이</label>
        <input type="number" id="d-age" placeholder="예: 28" min="18" max="80" style="max-width:120px;">
      </div>
    </div>

    <h3>전문 분야</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="d-field">주요 전문 분야</label>
        <select id="d-field">
          <option value="">선택</option>
          <option value="audio_engineer">오디오 엔지니어링 / 음향</option>
          <option value="music_production">음악 프로듀싱 / 작곡</option>
          <option value="spatial_audio">공간 오디오 / 이머시브 오디오</option>
          <option value="music_research">음악 / 오디오 연구</option>
          <option value="cs_ai">컴퓨터과학 / AI</option>
          <option value="musician">연주 / 성악</option>
          <option value="game_vr">게임 / VR / XR</option>
          <option value="other">기타</option>
        </select>
      </div>
      <div class="form-group">
        <label for="d-years">해당 분야 활동 연수</label>
        <select id="d-years">
          <option value="">선택</option>
          <option value="0-1">1년 미만</option>
          <option value="1-3">1~3년</option>
          <option value="3-5">3~5년</option>
          <option value="5-10">5~10년</option>
          <option value="10+">10년 이상</option>
        </select>
      </div>
    </div>

    <h3>청취 환경</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="d-headphone">사용 중인 청취 장비</label>
        <select id="d-headphone">
          <option value="">선택</option>
          <option value="over-ear-closed">오버이어 밀폐형 헤드폰 (권장)</option>
          <option value="over-ear-open">오버이어 개방형 헤드폰</option>
          <option value="on-ear">온이어 헤드폰</option>
          <option value="in-ear">인이어 이어폰</option>
          <option value="earbuds">에어팟 / 무선 이어버드</option>
          <option value="other">기타</option>
        </select>
      </div>
      <div class="form-group">
        <label for="d-headphone-model">장비 모델명 (선택)</label>
        <input type="text" id="d-headphone-model" placeholder="예: Sony MDR-7506">
      </div>
    </div>

    <div class="form-group">
      <label for="d-listening-exp">청취 평가 참여 경험</label>
      <select id="d-listening-exp">
        <option value="">선택</option>
        <option value="none">없음 (처음)</option>
        <option value="1-3">1~3회</option>
        <option value="4-10">4~10회</option>
        <option value="10+">10회 이상</option>
      </select>
    </div>

    <div class="form-group">
      <label for="d-spatial-familiarity">공간 오디오 (바이노럴/서라운드) 친숙도</label>
      <select id="d-spatial-familiarity">
        <option value="">선택</option>
        <option value="none">전혀 모름</option>
        <option value="heard">들어본 적 있음</option>
        <option value="familiar">어느 정도 알고 있음</option>
        <option value="expert">전문적으로 다루고 있음</option>
      </select>
    </div>
  </div>

  <p style="margin-top: 20px;">
    <button class="btn btn-secondary" onclick="goToIntro()" style="margin-right:10px;">이전</button>
    <button class="btn btn-primary" onclick="goToTest()">다음: 헤드폰 확인</button>
  </p>
</div>

<!-- ==================== Page 2.5: 헤드폰 확인 및 볼륨 조절 ==================== -->
<div id="page-headphone-check" class="page">
  <h1>헤드폰 확인 및 볼륨 조절</h1>

  <div class="info-box">
    <strong>1단계: 좌/우 헤드폰 확인</strong>
    <p style="margin-top:8px;">아래 버튼을 눌러 좌측(L)과 우측(R)에서 각각 소리가 나는지 확인해 주세요.<br>소리가 올바른 방향에서 들리지 않으면 헤드폰 착용을 확인해 주세요.</p>
  </div>

  <div class="headphone-check">
    <button class="btn btn-secondary" onclick="playLRCheck('left')">왼쪽(L) 재생</button>
    <button class="btn btn-secondary" onclick="playLRCheck('right')">오른쪽(R) 재생</button>
    <div class="check-result" id="lr-check-result"></div>
  </div>

  <div class="info-box" style="margin-top:20px;">
    <strong>2단계: 볼륨 조절</strong>
    <p style="margin-top:8px;">아래 버튼을 눌러 기준 음원을 재생한 후, <strong>편안하게 들리는 볼륨</strong>으로 조절해 주세요.<br>이후 평가가 끝날 때까지 <strong>볼륨을 변경하지 마세요.</strong></p>
  </div>

  <div class="headphone-check">
    <button class="btn btn-secondary" onclick="playCalibration()">기준 음원 재생</button>
    <button class="btn btn-secondary" onclick="stopCalibration()">정지</button>
    <p style="margin-top:10px; color:#888; font-size:0.85em;">약 5초간 재생됩니다. 음량을 편안한 수준으로 맞춰 주세요.</p>
  </div>

  <div style="margin-top:20px;">
    <div class="consent-row">
      <input type="checkbox" id="headphone-confirm">
      <label for="headphone-confirm" style="display:inline; font-weight:normal; color: #ccc;">
        좌/우 소리가 올바르게 들리며, 볼륨을 편안한 수준으로 설정했습니다.
      </label>
    </div>
  </div>

  <p style="margin-top: 20px;">
    <button class="btn btn-secondary" onclick="goBackToDemographic()" style="margin-right:10px;">이전</button>
    <button class="btn btn-primary" onclick="goToTestFromCheck()">평가 시작</button>
  </p>
</div>

<!-- ==================== Page 3: 평가 ==================== -->
<div id="test-page" class="page">
  <div class="header-bar">
    <h2 id="clip-header"></h2>
    <span class="progress-text" id="prog-text"></span>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>


  <!-- Video -->
  <div class="video-box">
    <video id="vid" muted playsinline></video>
  </div>

  <!-- Version toggle -->
  <div class="version-toggle">
    <button class="ver-btn active" id="ver-btn-0" onclick="switchVersion(0)">버전 1</button>
    <button class="ver-btn" id="ver-btn-1" onclick="switchVersion(1)">버전 2</button>
    <button class="mono-btn" id="mono-btn" onclick="switchVersion(2)">모노 (참조용)</button>
  </div>

  <div class="play-row">
    <button class="btn btn-secondary" onclick="playSync()">&#9654; 재생</button>
    <button class="btn btn-secondary" onclick="stopSync()" style="margin-left:8px;">&#9724; 정지</button>
    <button class="btn btn-secondary btn-sm" onclick="restartSync()" style="margin-left:8px;">&#8634; 처음부터</button>
  </div>

  <!-- Rating for current version -->
  <div id="rating-area">
    <div style="text-align:center; margin:12px 0; font-weight:600; color:#e94560;" id="rating-version-label">평가: 버전 1</div>
    <div class="rating-grid" id="rating-grid"></div>
  </div>

  <div class="nav-row">
    <button class="btn btn-secondary" id="prev-btn" onclick="prevClip()">이전 클립</button>
    <button class="btn btn-primary" id="next-btn" onclick="nextClip()">다음 클립</button>
  </div>
</div>

<!-- ==================== Page 4: 완료 ==================== -->
<div id="results" class="page">
  <h2>평가 완료</h2>
  <p class="thank-you">참여해 주셔서 감사합니다!</p>
  <p id="save-status">응답을 서버에 저장하는 중...</p>

  <div class="form-group" style="margin-top:16px;">
    <label for="d-comment">추가 의견 (선택)</label>
    <textarea id="d-comment" rows="4" style="background:#16213e; border:1px solid #444; color:#eee; padding:10px; border-radius:6px; width:100%; max-width:600px; font-size:0.95em; resize:vertical;" placeholder="평가 과정에서 느낀 점, 개선 제안, 공간 오디오에 대한 의견 등을 자유롭게 작성해 주세요."></textarea>
    <button class="btn btn-sm btn-secondary" onclick="saveComment()" style="margin-top:8px;">의견 제출</button>
  </div>

  <div id="results-summary"></div>
  <p style="margin-top:20px;">
    <button class="btn btn-primary" onclick="downloadResults()">결과 다운로드 (JSON)</button>
  </p>
  <p style="margin-top:16px; color:#888; font-size:0.85em;">
    문의사항: <strong>백승렬</strong> &mdash; 010-9265-8369
  </p>
</div>

</div>

<script>
// ==================== State ====================
let CFG = null;
let demographic = {};
let clipOrder = [];
let currentClipIdx = 0;
let condOrder = {};
let activeVersion = 0;
let ratings = {};

const SCALE_MIN = 1;
const SCALE_MAX = 5;

const vid = document.getElementById('vid');
let audioCtx = null;
let audioBuffers = {};
let currentSource = null;

// Korean question definitions (override config)
const QUESTIONS_KO = [
  {
    id: 'alignment',
    text: '공간 일치도 (Spatial Alignment)',
    instruction: '소리의 위치가 영상 속 물체의 위치/움직임과 얼마나 일치합니까?',
    anchors: {1: '전혀 불일치', 2: '대체로 불일치', 3: '보통', 4: '대체로 일치', 5: '정확히 일치'}
  },
  {
    id: 'smoothness',
    text: '움직임 부드러움 (Motion Smoothness)',
    instruction: '공간 오디오의 움직임이 얼마나 부드럽고 자연스럽습니까?',
    anchors: {1: '심한 끊김/튐', 2: '다소 부자연스러움', 3: '보통', 4: '대체로 부드러움', 5: '완전히 자연스러움'}
  },
  {
    id: 'depth',
    text: '거리감 (Depth Perception)',
    instruction: '가까이/멀리의 거리 변화가 얼마나 설득력 있게 느껴집니까?',
    anchors: {1: '거리감 없음', 2: '약간 느껴짐', 3: '보통', 4: '대체로 설득력 있음', 5: '매우 자연스러움'}
  },
  {
    id: 'overall',
    text: '종합 품질 (Overall Quality)',
    instruction: '전반적인 공간 오디오 품질을 어떻게 평가하시겠습니까?',
    anchors: {1: '나쁨', 2: '미흡', 3: '보통', 4: '좋음', 5: '매우 좋음'}
  }
];

// ==================== Load config ====================
async function loadConfig() {
  try {
    const r = await fetch('/evaluation/listening_test/stimuli/config.json');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    CFG = await r.json();
    console.log(`Config loaded: ${CFG.scenes.length} scenes`);
  } catch(e) {
    console.error('Config 로드 실패:', e);
    alert('설정 파일을 불러올 수 없습니다. 페이지를 새로고침해 주세요.');
  }
}
loadConfig();

// ==================== Audio ====================
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

async function loadAudioBuffer(url) {
  if (audioBuffers[url]) return audioBuffers[url];
  try {
    const ctx = getAudioCtx();
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const arrayBuf = await resp.arrayBuffer();
    const buf = await ctx.decodeAudioData(arrayBuf);
    audioBuffers[url] = buf;
    return buf;
  } catch(e) {
    console.error('오디오 로드 실패:', url, e);
    return null;
  }
}

// ==================== Page Navigation ====================
function goToDemographic() {
  if (!document.getElementById('consent-check').checked) {
    alert('안내 사항을 읽고 동의란에 체크해 주세요.');
    return;
  }
  document.getElementById('page-intro').classList.remove('active');
  document.getElementById('page-demographic').classList.add('active');
  window.scrollTo(0, 0);
}

function goToIntro() {
  document.getElementById('page-demographic').classList.remove('active');
  document.getElementById('page-intro').classList.add('active');
  window.scrollTo(0, 0);
}

function goToTest() {
  if (!CFG) { alert('설정이 아직 로드되지 않았습니다. 페이지를 새로고침해 주세요.'); return; }
  // Validate demographics
  const name = document.getElementById('d-name').value.trim();
  const contact = document.getElementById('d-contact').value.trim();
  const gender = document.getElementById('d-gender').value;
  const age = document.getElementById('d-age').value;
  const field = document.getElementById('d-field').value;
  const years = document.getElementById('d-years').value;
  const headphone = document.getElementById('d-headphone').value;
  const listeningExp = document.getElementById('d-listening-exp').value;
  const spatialFam = document.getElementById('d-spatial-familiarity').value;

  if (!name) { alert('성명을 입력해 주세요.'); return; }
  if (!contact) { alert('연락처를 입력해 주세요.'); return; }
  if (!gender) { alert('성별을 선택해 주세요.'); return; }
  if (!age) { alert('나이를 입력해 주세요.'); return; }
  if (!field) { alert('전문 분야를 선택해 주세요.'); return; }
  if (!years) { alert('활동 연수를 선택해 주세요.'); return; }
  if (!headphone) { alert('청취 장비를 선택해 주세요.'); return; }
  if (!listeningExp) { alert('청취 평가 참여 경험을 선택해 주세요.'); return; }
  if (!spatialFam) { alert('공간 오디오 친숙도를 선택해 주세요.'); return; }

  demographic = {
    name, contact, gender,
    age: parseInt(age),
    field, years_experience: years,
    headphone_type: headphone,
    headphone_model: document.getElementById('d-headphone-model').value.trim(),
    listening_test_experience: listeningExp,
    spatial_audio_familiarity: spatialFam,
  };

  // Generate PID from name hash
  const PID = name.replace(/\s/g, '') + '_' + Date.now().toString(36);

  // Setup test
  const rng = makeRng(hashStr(PID));
  clipOrder = shuffle([...Array(CFG.scenes.length).keys()], rng);

  const conds = CFG.conditions.filter(c => c.id !== 'mono').map(c => c.id);
  for (const scene of CFG.scenes) {
    const rngClip = makeRng(hashStr(PID + scene.id));
    condOrder[scene.id] = shuffle([...conds], rngClip);
  }

  ratings = {};
  currentClipIdx = 0;

  // Go to headphone check page instead of directly to test
  document.getElementById('page-demographic').classList.remove('active');
  document.getElementById('page-headphone-check').classList.add('active');
  window.scrollTo(0, 0);
}

function goBackToDemographic() {
  document.getElementById('page-headphone-check').classList.remove('active');
  document.getElementById('page-demographic').classList.add('active');
  window.scrollTo(0, 0);
}

function goToTestFromCheck() {
  if (!document.getElementById('headphone-confirm').checked) {
    alert('헤드폰 확인 및 볼륨 조절을 완료한 후 체크해 주세요.');
    return;
  }
  stopCalibration();
  document.getElementById('page-headphone-check').classList.remove('active');
  document.getElementById('test-page').classList.add('active');
  window.scrollTo(0, 0);
  showClip();
}

// ==================== Headphone L/R Check ====================
function playLRCheck(side) {
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const panner = ctx.createStereoPanner();
  osc.type = 'sine';
  osc.frequency.value = side === 'left' ? 440 : 880;
  gain.gain.value = 0.3;
  panner.pan.value = side === 'left' ? -1 : 1;
  osc.connect(gain).connect(panner).connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 1.0);
  const label = side === 'left' ? '왼쪽(L)' : '오른쪽(R)';
  document.getElementById('lr-check-result').innerHTML =
    `<span class="check-pass">${label}에서 소리가 재생되었습니다.</span>`;
}

let calibrationSource = null;
function playCalibration() {
  stopCalibration();
  const ctx = getAudioCtx();
  // Generate 5s pink-ish noise for calibration
  const sr = ctx.sampleRate;
  const len = sr * 5;
  const buf = ctx.createBuffer(2, len, sr);
  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
    for (let i = 0; i < len; i++) {
      const white = Math.random() * 2 - 1;
      b0 = 0.99886*b0 + white*0.0555179;
      b1 = 0.99332*b1 + white*0.0750759;
      b2 = 0.96900*b2 + white*0.1538520;
      b3 = 0.86650*b3 + white*0.3104856;
      b4 = 0.55000*b4 + white*0.5329522;
      b5 = -0.7616*b5 - white*0.0168980;
      d[i] = (b0+b1+b2+b3+b4+b5+b6+white*0.5362) * 0.04;
      b6 = white * 0.115926;
    }
  }
  calibrationSource = ctx.createBufferSource();
  calibrationSource.buffer = buf;
  calibrationSource.connect(ctx.destination);
  calibrationSource.start();
  calibrationSource.onended = () => { calibrationSource = null; };
}

function stopCalibration() {
  if (calibrationSource) {
    try { calibrationSource.stop(); } catch(e) {}
    calibrationSource = null;
  }
}

// ==================== Show clip ====================
function showClip() {
  if (currentClipIdx >= clipOrder.length) { finishTest(); return; }

  const sceneIdx = clipOrder[currentClipIdx];
  const scene = CFG.scenes[sceneIdx];
  const order = condOrder[scene.id];

  document.getElementById('clip-header').textContent =
    `클립 ${currentClipIdx + 1} / ${clipOrder.length}`;
  document.getElementById('prog-text').textContent =
    `${currentClipIdx + 1} / ${clipOrder.length}`;
  document.getElementById('prog-fill').style.width =
    `${((currentClipIdx + 1) / clipOrder.length) * 100}%`;

  // Video - use video from eval_clips directory
  vid.src = `/data/lasot/eval_clips/${scene.id}/video.mp4`;
  vid.load();

  // Preload audio from review_samples
  for (const cid of order) {
    loadAudioBuffer(`/data/lasot/review_samples/${scene.id}/${scene.id}_${cid}.wav`);
  }
  loadAudioBuffer(`/data/lasot/review_samples/${scene.id}/${scene.id}_mono.wav`);

  if (!ratings[scene.id]) {
    ratings[scene.id] = {};
    for (const cid of order) {
      ratings[scene.id][cid] = {};
    }
  }

  activeVersion = 0;
  updateVersionButtons();
  renderRatingGrid();

  document.getElementById('prev-btn').disabled = (currentClipIdx === 0);
  document.getElementById('next-btn').textContent =
    currentClipIdx === clipOrder.length - 1 ? '평가 완료' : '다음 클립';

  window.scrollTo(0, 0);
}

// ==================== Version switching ====================
function switchVersion(v) {
  stopSync();
  activeVersion = v;
  updateVersionButtons();
  renderRatingGrid();
}

function updateVersionButtons() {
  document.getElementById('ver-btn-0').classList.toggle('active', activeVersion === 0);
  document.getElementById('ver-btn-1').classList.toggle('active', activeVersion === 1);
  document.getElementById('mono-btn').classList.toggle('active', activeVersion === 2);

  const label = document.getElementById('rating-version-label');
  if (activeVersion === 2) {
    label.textContent = '모노 참조용 (평가 대상 아님)';
    document.getElementById('rating-grid').innerHTML =
      '<p style="text-align:center;color:#888;padding:16px;">모노는 비교 기준으로만 제공됩니다. 버전 1 또는 2로 전환하여 평가해 주세요.</p>';
  } else {
    label.textContent = `평가: 버전 ${activeVersion + 1}`;
  }
}

// ==================== Audio/Video sync ====================
function getAudioUrl() {
  const sceneIdx = clipOrder[currentClipIdx];
  const scene = CFG.scenes[sceneIdx];
  const order = condOrder[scene.id];

  if (activeVersion === 2) {
    return `/data/lasot/review_samples/${scene.id}/${scene.id}_mono.wav`;
  } else {
    const cid = order[activeVersion];
    return `/data/lasot/review_samples/${scene.id}/${scene.id}_${cid}.wav`;
  }
}

let playId = 0;
function playSync() {
  const ctx = getAudioCtx();
  if (ctx.state === 'suspended') ctx.resume();

  stopSync();
  const myId = ++playId;

  const audioUrl = getAudioUrl();
  loadAudioBuffer(audioUrl).then(buf => {
    if (myId !== playId) return; // stale callback — user switched version
    if (!buf) { alert('오디오를 불러올 수 없습니다. 페이지를 새로고침해 주세요.'); return; }
    const source = ctx.createBufferSource();
    source.buffer = buf;
    source.connect(ctx.destination);

    vid.currentTime = 0;
    vid.play();
    source.start(0);
    currentSource = source;
    source.onended = () => { if (currentSource === source) currentSource = null; };
  });
}

// Stop audio when video ends (sync protection)
vid.addEventListener('ended', () => {
  if (currentSource) {
    try { currentSource.stop(); } catch(e) {}
    currentSource = null;
  }
});

function stopSync() {
  vid.pause();
  if (currentSource) {
    try { currentSource.stop(); } catch(e) {}
    currentSource = null;
  }
}

function restartSync() {
  stopSync();
  playSync();
}

// ==================== Rating grid ====================
function renderRatingGrid() {
  const grid = document.getElementById('rating-grid');
  if (activeVersion === 2) return;

  const sceneIdx = clipOrder[currentClipIdx];
  const scene = CFG.scenes[sceneIdx];
  const order = condOrder[scene.id];
  const condId = order[activeVersion];
  const saved = ratings[scene.id][condId] || {};

  let html = '';
  for (const q of QUESTIONS_KO) {
    const selVal = saved[q.id] || 0;
    html += `<div class="question-block">
      <div class="q-header">
        <span class="q-title">${q.text}</span>
      </div>
      <div class="q-instruction">${q.instruction}</div>
      <div class="scale-labels">`;
    for (let v = SCALE_MIN; v <= SCALE_MAX; v++) {
      html += `<span>${q.anchors[v]}</span>`;
    }
    html += `</div><div class="scale-row">`;
    for (let v = SCALE_MIN; v <= SCALE_MAX; v++) {
      html += `<button class="scale-btn ${selVal === v ? 'selected' : ''}"
                 onclick="rate('${q.id}', ${v})">${v}</button>`;
    }
    html += `</div></div>`;
  }
  grid.innerHTML = html;
}

function rate(qId, value) {
  const sceneIdx = clipOrder[currentClipIdx];
  const scene = CFG.scenes[sceneIdx];
  const order = condOrder[scene.id];
  const condId = order[activeVersion];

  if (!ratings[scene.id][condId]) ratings[scene.id][condId] = {};
  ratings[scene.id][condId][qId] = value;
  renderRatingGrid();
}

// ==================== Navigation ====================
function nextClip() {
  const sceneIdx = clipOrder[currentClipIdx];
  const scene = CFG.scenes[sceneIdx];
  const order = condOrder[scene.id];
  const numQ = QUESTIONS_KO.length;

  for (let v = 0; v < order.length; v++) {
    const cid = order[v];
    const r = ratings[scene.id][cid] || {};
    const answered = Object.keys(r).length;
    if (answered < numQ) {
      alert(`버전 ${v + 1}의 모든 차원을 평가해 주세요.`);
      switchVersion(v);
      return;
    }
  }

  stopSync();
  currentClipIdx++;
  showClip();
}

function prevClip() {
  if (currentClipIdx > 0) {
    stopSync();
    currentClipIdx--;
    showClip();
  }
}

// ==================== Finish ====================
function finishTest() {
  stopSync();
  document.getElementById('test-page').classList.remove('active');
  document.getElementById('results').classList.add('active');
  window.scrollTo(0, 0);

  const trials = [];
  for (const sceneIdx of clipOrder) {
    const scene = CFG.scenes[sceneIdx];
    const order = condOrder[scene.id];
    for (let v = 0; v < order.length; v++) {
      const condId = order[v];
      const r = ratings[scene.id][condId] || {};
      trials.push({
        scene: scene.id,
        motion: scene.motion,
        category: scene.category,
        instrument: scene.instrument,
        condition: condId,
        blind_label: `Version ${v + 1}`,
        ratings: r,
      });
    }
  }

  const result = {
    participant: demographic,
    timestamp: new Date().toISOString(),
    num_clips: clipOrder.length,
    questions: QUESTIONS_KO.map(q => q.id),
    scale: '1-5 MOS',
    clip_order: clipOrder.map(i => CFG.scenes[i].id),
    condition_order: condOrder,
    trials: trials,
  };

  window._results = result;

  fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(result),
  }).then(r => {
    if (r.ok) {
      console.log('결과가 서버에 저장되었습니다.');
      document.getElementById('save-status').innerHTML =
        '<span style="color:#4ade80;">응답이 서버에 저장되었습니다.</span>';
    } else {
      throw new Error(`HTTP ${r.status}`);
    }
  }).catch(e => {
    console.warn('서버 저장 실패:', e);
    document.getElementById('save-status').innerHTML =
      '<span style="color:#f87171;">서버 저장에 실패했습니다. 아래 버튼으로 JSON 파일을 다운로드해 주세요.</span>';
  });

  showSummary(result);
}

function saveComment() {
  const comment = document.getElementById('d-comment').value.trim();
  if (!comment) { alert('의견을 입력해 주세요.'); return; }
  if (window._results) {
    window._results.comment = comment;
    fetch('/api/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(window._results),
    }).then(() => alert('의견이 저장되었습니다. 감사합니다!')).catch(() => alert('저장 실패'));
  }
}

function showSummary(result) {
  const div = document.getElementById('results-summary');
  const condIds = [...new Set(result.trials.map(t => t.condition))];
  const qIds = result.questions;

  let html = '<h3 style="margin-top:16px;">차원별 평균 점수</h3>';
  html += '<table class="result-table"><tr><th>평가 차원</th>';
  for (const cid of condIds) {
    html += `<th>${cid}</th>`;
  }
  html += '</tr>';

  for (const qId of qIds) {
    const qDef = QUESTIONS_KO.find(q => q.id === qId);
    html += `<tr><td>${qDef ? qDef.text : qId}</td>`;
    for (const cid of condIds) {
      const vals = result.trials
        .filter(t => t.condition === cid)
        .map(t => t.ratings[qId])
        .filter(v => v != null);
      const mean = vals.length ? (vals.reduce((a,b)=>a+b,0) / vals.length).toFixed(2) : '\u2014';
      html += `<td>${mean}</td>`;
    }
    html += '</tr>';
  }
  html += '</table>';
  div.innerHTML = html;
}

function downloadResults() {
  const blob = new Blob([JSON.stringify(window._results, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vid2spatial_eval_${demographic.name || 'unknown'}_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ==================== Page leave protection ====================
window.addEventListener('beforeunload', function(e) {
  // Only warn if test is in progress (has ratings)
  if (Object.keys(ratings).length > 0 && !window._results) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// ==================== Utilities ====================
function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) - h) + s.charCodeAt(i);
    h |= 0;
  }
  return Math.abs(h);
}

function makeRng(seed) {
  let a = seed;
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function shuffle(arr, rng) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
</script>

</body>
</html>
